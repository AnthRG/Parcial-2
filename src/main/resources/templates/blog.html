<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Blog</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <style>
        .blog-header {
            line-height: 1;
            border-bottom: 1px solid #000000;
        }

        .blog-header-logo {
            font-family: "Playfair Display", Georgia, "Times New Roman", serif;
            font-size: 2.25rem;
            text-decoration: none; /* This ensures there is no underline by default */
        }

        .blog-header-logo:hover {
            text-decoration: none;
        }

        .blog-post-title {
            font-size: 2.5rem;
        }

        .blog-post-meta {
            font-family: "Arial", sans-serif;
            font-size: 1rem;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="blog-header py-3">
        <div class="row flex-nowrap justify-content-between align-items-center">
            <div class="col-4 pt-1">
                <a class="btn btn-sm btn-outline-secondary" th:if="${session.USUARIO == null}"
                   href="http://localhost:7070/registro">Registrar</a>
                <a class="btn btn-sm btn-outline-secondary" th:if="${session.USUARIO != null}"
                   href="http://localhost:7070/menu">Menu</a>
            </div>
            <div class="col-4 text-center">
                <a class="blog-header-logo text-dark">Mi Blog</a>
            </div>
            <div class="col-4 d-flex justify-content-end align-items-center">
                <!-- Si no hay usuario en sesión, mostrar botón de Iniciar Sesión -->
                <a class="btn btn-sm btn-outline-secondary" th:if="${session.USUARIO == null}"
                   href="http://localhost:7070/formulario">Iniciar sesión</a>

                <!-- Si hay usuario en sesión, mostrar mensaje de bienvenida y botón de Cerrar Sesión -->
                <span th:if="${session.USUARIO != null}">
                    <span th:text="'Bienvenido, '+${session.USUARIO.nombre}"></span>
                    <a class="btn btn-sm btn-outline-danger ms-2" href="http://localhost:7070/logout">Cerrar sesión</a>
                </span>
            </div>

        </div>
    </header>

    <div class="nav-scroller py-1 mb-2">
        <nav class="nav nav-underline justify-content-between">
            <a th:each="etiqueta : ${ListEtiquetas}"
               class="nav-item nav-link link-body-emphasis"
               th:text="${etiqueta.etiqueta}"
               th:href="'http://localhost:7070/blog/etiqueta/'+${etiqueta.etiqueta}">
            </a>
        </nav>
    </div>
</div>

<main class="container">
    <div id="articulos"></div>

    <div class="row g-5">
        <div class="col-md-8">
            <h3 class="pb-4 mb-4 fst-italic border-bottom">
                Desde el Archivo
            </h3>
            <article class="blog-post">
                <h2 class="blog-post-title" th:text="${ARTICULOPRIN.titulo}">Título de la publicación</h2>
                <p class="blog-post-meta" th:text="${FECHA}"></p>
                <p class="blog-post-meta" th:text="${AUTOR}">Por Autor</p>
                <p th:utext="${ARTICULOPRIN.cuerpo}">Aquí irá el contenido del artículo.</p>
            </article>

            <!-- Sección de comentarios -->
            <div class="mt-4">
                <h4>Comentarios</h4>
                <div th:each="comentario : ${listaComentarios}"
                     style="background-color: #f1f1f1; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd;">
                    <p>
                        <strong th:text="${comentario.autor.nombre}"></strong> dijo:
                        <img th:if="${comentario.autor} ? ${comentario.autor.foto != null}"
                             th:src="'data:' + ${comentario.autor.foto.mimeType} + ';base64,' + ${comentario.autor.foto.fotoBase64}"
                             alt="Foto de perfil"
                             style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;"/>
                    </p>
                    <p th:text="${comentario.contenido}"></p>
                    <p class="text-muted" th:text="${#dates.format(comentario.fecha, 'dd/MM/yyyy HH:mm')}"
                       style="font-size: 0.9em; color: #666;"></p>
                </div>
            </div>

            <!-- Formulario para dejar un comentario (solo para usuarios autenticados) -->
            <div class="mt-4" th:if="${session.USUARIO != null}">
                <h4>Deja un comentario</h4>
                <form action="/comentar" method="post">
                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentario:</label>
                        <textarea class="form-control" id="comentario" name="comentario" rows="3" required></textarea>
                    </div>
                    <input type="hidden" name="articuloId" th:value="${ARTICULOPRIN.id}">
                    <button type="submit" class="btn btn-primary">Comentar</button>
                </form>
            </div>

            <!-- Mensaje para usuarios no autenticados -->
            <div class="mt-4" th:if="${session.USUARIO == null}">
                <p>Debes <a href="/formulario">iniciar sesión</a> para dejar un comentario.</p>
            </div>
        </div> <!-- Cierre del col-md-8 -->

        <!-- Columna lateral -->
        <div class="col-md-4">
            <div class="position-sticky" style="top: 2rem;">
                <div class="p-4 mb-3 bg-light rounded">
                    <h4 class="fst-italic">Acerca de Mi Blog</h4>
                    <p class="mb-0">
                        Mi Blog es un blog que nace con la misión de inspirar, explorar y conectar ideas.
                        En sus páginas, encontrarás artículos sobre tecnología, arte, cultura, ciencia y bienestar,
                        escritos con pasión por un equipo diverso de creadores. Cada publicación busca ofrecer una
                        visión fresca y única sobre temas de actualidad, mientras fomenta el pensamiento crítico y la
                        creatividad. Si eres curioso, amante del conocimiento y de las experiencias enriquecedoras,
                        este es tu lugar para descubrir y compartir lo que el mundo tiene para ofrecer.
                        ¡Bienvenido a la aventura del saber!
                    </p>
                </div>
            </div>
        </div> <!-- Cierre del col-md-4 -->
    </div> <!-- Cierre del row g-5 -->
</main> <!-- Cierre del container -->

</main>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!-- Script para cargar artículos dinámicamente -->
<script th:inline="javascript">
    /*<![CDATA[*/

    async function cargarArticulos(cantidad) {
        try {
            const response = await fetch(`/articul?cantidad=${cantidad}`);

            if (!response.ok) {
                throw new Error(`Error al cargar artículos: ${response.statusText}`);
            }

            const articulos = await response.json();

            const contenedor = document.getElementById('articulos');
            if (!contenedor) {
                return;
            }

            contenedor.innerHTML = ''; // Limpiar el contenedor

            const filaHTML = document.createElement('div');
            filaHTML.className = 'row';

            const currentPath = window.location.pathname;

            // Filtrar los artículos para excluir el artículo principal
            const pathSegments = currentPath.split('/');
            const articuloPrincipalId = pathSegments[pathSegments.length - 1];
            let articulosFiltrados = articulos.filter(articulo => articulo.id !== articuloPrincipalId);
            console.log(articulosFiltrados);
            articulosFiltrados = articulosFiltrados.slice(0, 2);
            //             const articuloDestacadoId = /*[[${ARTICULOPRIN.id}]]*/ null;

            const articuloDestacadoId = null;

            articulosFiltrados.forEach(articulo => {
                if (articulo.id !== articuloDestacadoId) {
                    const contenidoLimitado = articulo.cuerpo ? articulo.cuerpo.substring(0, 100) + "..." : "Sin contenido";
                    const etiquetas = articulo.listaEtiquetas || [];
                    const fechaFormateada = formatearFecha(articulo.fecha);
                    const etiquetasHTML = etiquetas.slice(0, 2).map(etiqueta => etiqueta.etiqueta).join(', ');

                    const articuloHTML = `
                <div class="col-md-6">
                    <div class="row g-0 border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
                        <div class="col p-4 d-flex flex-column position-static">
                            <strong class="d-inline-block mb-2 text-primary">Etiquetas: ${etiquetasHTML}</strong>
                            <h3 class="mb-0">${articulo.titulo}</h3>
                            <div class="mb-1 text-muted">${fechaFormateada}</div>
                            <p class="card-text mb-auto">${contenidoLimitado}
                                <a href="http://localhost:7070/blog/articulo/${articulo.id}" >Continuar leyendo</a>
                            </p>
                        </div>
                    </div>
                </div>
            `;

                    filaHTML.innerHTML += articuloHTML;
                }
            });

            contenedor.appendChild(filaHTML);
        } catch (error) {
            console.error("Error en cargarArticulos:", error);
            document.getElementById('articulos').innerHTML = `<p class="text-danger">Error al cargar los artículos: ${error.message}</p>`;
        }
    }

    function formatearFecha(fecha) {
        if (!fecha) return "Fecha desconocida";
        return new Date(fecha).toLocaleDateString('es-ES', {
            weekday: 'short',
            month: 'short',
            day: '2-digit',
            year: 'numeric'
        });
    }

    window.onload = () => {
        console.log("Página cargada, llamando a cargarArticulos...");
        cargarArticulos(3);
    };

    function insertarCuerpoEnParrafos(cuerpo) {
        if (!cuerpo) return '';
        return cuerpo.split('\n').map(parrafo => `<p>${parrafo}</p>`).join('');
    }
    /*]]>*/
</script>
</body>
</html>