<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Blog</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <style>
        .blog-header {
            line-height: 1;
            border-bottom: 1px solid #000000;
        }

        .blog-header-logo {
            font-family: "Playfair Display", Georgia, "Times New Roman", serif;
            font-size: 2.25rem;
            text-decoration: none; /* This ensures there is no underline by default */
        }

        .blog-header-logo:hover {
            text-decoration: none;
        }

        .blog-post-title {
            font-size: 2.5rem;
        }

        .blog-post-meta {
            font-family: "Arial", sans-serif;
            font-size: 1rem;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="blog-header py-3">
        <div class="row flex-nowrap justify-content-between align-items-center">
            <div class="col-4 pt-1">
                <a class="btn btn-sm btn-outline-secondary" href="http://localhost:7070/registro.html">Registrar</a>
            </div>
            <div class="col-4 text-center">
                <a class="blog-header-logo text-dark" href="#">Mi Blog</a>
            </div>
            <div class="col-4 d-flex justify-content-end align-items-center">
                <a class="btn btn-sm btn-outline-secondary" href="http://localhost:7070/formulario.html">Iniciar sesión</a>
            </div>
        </div>
    </header>

    <div class="nav-scroller py-1 mb-2">
        <nav class="nav nav-underline justify-content-between">
            <a class="nav-item nav-link link-body-emphasis" href="#">World</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">U.S.</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Technology</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Design</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Culture</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Business</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Politics</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Opinion</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Science</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Health</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Style</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Travel</a>
        </nav>
    </div>
</div>

<main class="container">
    <div id="articulos"></div>
</main>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script para cargar artículos dinámicamente -->
<script>
    async function cargarArticulos(cantidad) {
        try {
            const response = await fetch(`/articulos?cantidad=${cantidad}`);

            if (!response.ok) {
                throw new Error(`Error al cargar artículos: ${response.statusText}`);
            }

            const articulos = await response.json();

            const contenedor = document.getElementById('articulos');
            if (!contenedor) {
                return;
            }

            contenedor.innerHTML = ''; // Limpiar el contenedor

            const filaHTML = document.createElement('div');
            filaHTML.className = 'row';

            const currentPath = window.location.pathname;

            // Filtrar los artículos para excluir el artículo principal
            const pathSegments = currentPath.split('/');
            const articuloPrincipalId = pathSegments[pathSegments.length - 1];
            const articulosFiltrados = articulos.filter(articulo => articulo.id !== articuloPrincipalId);
            console.log(articulosFiltrados);

            articulosFiltrados.forEach(articulo => {
                let esta = false;
                articulo.listaEtiquetas.forEach(etiq =>{
                    if(etiq.nombre == currentPath){
                        esta = true;
                    }
                })
                //if esta ejecutar abajo si no no,
                // recordar tambien poner a funcionar que el articulos filtrados sean todos los articulos
                const contenidoLimitado = articulo.cuerpo ? articulo.cuerpo.substring(0, 100) + "..." : "Sin contenido";
                const etiquetas = articulo.listaEtiquetas || [];
                const fechaFormateada = formatearFecha(articulo.fecha);
                const etiquetasHTML = etiquetas.slice(0, 2).map(etiqueta => etiqueta.etiqueta).join(', ');

                const articuloHTML = `
                <div class="col-md-6">
                    <div class="row g-0 border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
                        <div class="col p-4 d-flex flex-column position-static">
                            <strong class="d-inline-block mb-2 text-primary">Etiquetas: ${etiquetasHTML}</strong>
                            <h3 class="mb-0">${articulo.titulo}</h3>
                            <div class="mb-1 text-muted">${fechaFormateada}</div>
                            <p class="card-text mb-auto">${contenidoLimitado}
                                <a href="http://localhost:7070/blog.html/${articulo.id}" class="stretched-link">Continuar leyendo</a>
                            </p>
                        </div>
                    </div>
                </div>
            `;

                filaHTML.innerHTML += articuloHTML;
            });

            contenedor.appendChild(filaHTML);
        } catch (error) {
            console.error("Error en cargarArticulos:", error);
            document.getElementById('articulos').innerHTML = `<p class="text-danger">Error al cargar los artículos: ${error.message}</p>`;
        }
    }

    function formatearFecha(fecha) {
        if (!fecha) return "Fecha desconocida";
        return new Date(fecha).toLocaleDateString('es-ES', {
            weekday: 'short',
            month: 'short',
            day: '2-digit',
            year: 'numeric'
        });
    }

    window.onload = () => {
        console.log("Página cargada, llamando a cargarArticulos...");
        cargarArticulos(2);
    };

    function insertarCuerpoEnParrafos(cuerpo) {
        if (!cuerpo) return '';
        return cuerpo.split('\n').map(parrafo => `<p>${parrafo}</p>`).join('');
    }

</script>
</body>
</html>